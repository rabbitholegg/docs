{"version":3,"file":"DeployableTargetWithRBAC.js","sources":["../../src/Deployable/DeployableTargetWithRBAC.ts"],"sourcesContent":["import {\n  rbacAbi,\n  readRbacHasAllRoles,\n  readRbacHasAnyRole,\n  readRbacIsAuthorized,\n  readRbacRolesOf,\n  simulateRbacGrantRoles,\n  simulateRbacRevokeRoles,\n  simulateRbacSetAuthorized,\n  writeRbacGrantRoles,\n  writeRbacRevokeRoles,\n  writeRbacSetAuthorized,\n} from '@boostxyz/evm';\nimport type { Abi, Address, ContractEventName } from 'viem';\nimport { DeployableTarget } from '../Deployable/DeployableTarget';\nimport type { GenericLog, ReadParams, WriteParams } from '../utils';\nexport { rbacAbi };\n\n/**\n *  Enum representing available roles for use with the `RBAC` authorization scheme.\n * `MANAGER` has lowest level of write permissions, for specific implementations, see Budgets and ALlowLists\n * `ADMIN` can additionally manage authorized users on the contract.\n *\n * @export\n * @type {{ readonly MANAGER: 1n; readonly ADMIN_ROLE: 2n; }}\n * @enum {bigint}\n */\nexport enum Roles {\n  //@ts-expect-error ts doesn't like bigint enum values\n  MANAGER = 1n,\n  //@ts-expect-error ts doesn't like bigint enum values\n  ADMIN = 2n,\n}\n\n/**\n * A generic `viem.Log` event with support for `Rbac` event types.\n *\n * @export\n * @typedef {RBACLog}\n * @template {ContractEventName<typeof rbacAbi>} [event=ContractEventName<\n *     typeof rbacAbi\n *   >]\n */\nexport type RBACLog<\n  event extends ContractEventName<typeof rbacAbi> = ContractEventName<\n    typeof rbacAbi\n  >,\n> = GenericLog<typeof rbacAbi, event>;\n\n/**\n * A minimal RBAC implementation that offers MANAGER and ADMIN roles, and\n * Budgets and allowlists support this auth scheme\n *\n * @export\n * @class DeployableTargetWithRBAC\n * @typedef {DeployableTargetWithRBAC}\n * @extends {DeployableTarget<RbacPayload>}\n */\nexport class DeployableTargetWithRBAC<\n  Payload,\n  ABI extends Abi,\n> extends DeployableTarget<Payload, ABI> {\n  /**\n   * Set the authorized status of the given accounts\n   * The mechanism for managing authorization is left to the implementing contract\n   *\n   * @public\n   * @async\n   * @param {Address[]} addresses - The accounts to authorize or deauthorize\n   * @param {boolean[]} allowed - The authorization status for the given accounts\n   * @param {?WriteParams} [params]\n   * @returns {Promise<void>}\n   */\n  public async setAuthorized(\n    addresses: Address[],\n    allowed: boolean[],\n    params?: WriteParams<typeof rbacAbi, 'setAuthorized'>,\n  ) {\n    return await this.awaitResult(\n      this.setAuthorizedRaw(addresses, allowed, params),\n    );\n  }\n\n  /**\n   * Set the authorized status of the given accounts\n   * The mechanism for managing authorization is left to the implementing contract\n   *\n   * @public\n   * @async\n   * @param {Address[]} addresses - The accounts to authorize or deauthorize\n   * @param {boolean[]} allowed - The authorization status for the given accounts\n   * @param {?WriteParams} [params]\n   * @returns {Promise<void>}\n   */\n  public async setAuthorizedRaw(\n    addresses: Address[],\n    allowed: boolean[],\n    params?: WriteParams<typeof rbacAbi, 'setAuthorized'>,\n  ) {\n    const { request, result } = await simulateRbacSetAuthorized(this._config, {\n      address: this.assertValidAddress(),\n      args: [addresses, allowed],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n    const hash = await writeRbacSetAuthorized(this._config, request);\n    return { hash, result };\n  }\n\n  /**\n   * Grant many accounts permissions on the rbac.\n   *\n   * @example\n   * ```ts\n   * await rbac.grantRoles(['0xfoo', '0xbar], [RbacRoles.MANAGER, RbacRoles.ADMIN])\n   * ```\n   * @public\n   * @async\n   * @param {Address[]} addresses\n   * @param {RbacRoles[]} roles\n   * @param {?WriteParams} [params]\n   * @returns {Promise<void>}\n   */\n  public async grantRoles(\n    addresses: Address[],\n    roles: Roles[],\n    params?: WriteParams<typeof rbacAbi, 'grantRoles'>,\n  ) {\n    return await this.awaitResult(this.grantRolesRaw(addresses, roles, params));\n  }\n\n  /**\n   * Grant many accounts permissions on the rbac.\n   *\n   * @example\n   * ```ts\n   * await rbac.grantRoles(['0xfoo', '0xbar], [Roles.MANAGER, Roles.ADMIN])\n   *\n   * @public\n   * @async\n   * @param {Address[]} addresses\n   * @param {RbacRoles[]} roles\n   * @param {?WriteParams} [params]\n   * @returns {Promise<{ hash: `0x${string}`; result: void; }>}\n   */\n  public async grantRolesRaw(\n    addresses: Address[],\n    roles: Roles[],\n    params?: WriteParams<typeof rbacAbi, 'grantRoles'>,\n  ) {\n    const { request, result } = await simulateRbacGrantRoles(this._config, {\n      address: this.assertValidAddress(),\n      args: [addresses, roles],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n    const hash = await writeRbacGrantRoles(\n      this._config,\n      // biome-ignore lint/suspicious/noExplicitAny: negligible low level lack of type intersection\n      request as any,\n    );\n    return { hash, result };\n  }\n\n  /**\n   * Revoke many accounts' permissions on the rbac.\n   *\n   * @example\n   * ```ts\n   * await rbac.revokeRoles(['0xfoo', '0xbar], [RbacRoles.MANAGER, RbacRoles.ADMIN])\n   *\n   * @public\n   * @async\n   * @param {Address[]} addresses\n   * @param {RbacRoles[]} roles\n   * @param {?WriteParams} [params]\n   * @returns {Promise<void>}\n   */\n  public async revokeRoles(\n    addresses: Address[],\n    roles: Roles[],\n    params?: WriteParams<typeof rbacAbi, 'revokeRoles'>,\n  ) {\n    return await this.awaitResult(\n      this.revokeRolesRaw(addresses, roles, params),\n    );\n  }\n\n  /**\n   * Revoke many accounts' permissions on the rbac.\n   *\n   * @example\n   * ```ts\n   * await rbac.revokeRoles(['0xfoo', '0xbar], [RbacRoles.MANAGER, RbacRoles.ADMIN])\n   * @public\n   * @async\n   * @param {Address[]} addresses\n   * @param {RbacRoles[]} roles\n   * @param {?WriteParams} [params]\n   * @returns {Promise<{ hash: `0x${string}`; result: void; }>}\n   */\n  public async revokeRolesRaw(\n    addresses: Address[],\n    roles: Roles[],\n    params?: WriteParams<typeof rbacAbi, 'revokeRoles'>,\n  ) {\n    const { request, result } = await simulateRbacRevokeRoles(this._config, {\n      address: this.assertValidAddress(),\n      args: [addresses, roles],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n    const hash = await writeRbacRevokeRoles(\n      this._config,\n      // biome-ignore lint/suspicious/noExplicitAny: negligible low level lack of type intersection\n      request as any,\n    );\n    return { hash, result };\n  }\n\n  /**\n   * Return an array of the roles assigned to the given account.\n   * @example\n   * ```ts\n   * (await rbac.rolesOf(0xfoo)).includes(RbacRoles.ADMIN)\n   * @public\n   * @param {Address} account\n   * @param {?ReadParams} [params]\n   * @returns {Promise<Array<RbacRoles>>}\n   */\n  public async rolesOf(\n    account: Address,\n    params?: ReadParams<typeof rbacAbi, 'rolesOf'>,\n  ) {\n    const roles = await readRbacRolesOf(this._config, {\n      address: this.assertValidAddress(),\n      args: [account],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n    return ([Roles.MANAGER, Roles.ADMIN] as unknown as Array<bigint>).filter(\n      (role) => (roles & role) === role,\n    ) as unknown as Roles[];\n  }\n\n  /**\n   * Returns whether given account has any of the provided roles bitmap.\n   *\n   * @example\n   * ```ts\n   * await rbac.hasAnyRole(0xfoo, RbacRoles.ADMIN | RbacRoles.MANAGER)\n   * @public\n   * @param {Address} account\n   * @param {RbacRoles} roles\n   * @param {?ReadParams} [params]\n   * @returns {Promise<boolean>}\n   */\n  public hasAnyRole(\n    account: Address,\n    roles: Roles,\n    params?: ReadParams<typeof rbacAbi, 'hasAnyRole'>,\n  ) {\n    return readRbacHasAnyRole(this._config, {\n      address: this.assertValidAddress(),\n      args: [account, roles],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n  }\n\n  /**\n   * Returns whether given account has all of the provided roles bitmap.\n   *\n   * @example\n   * ```ts\n   * await rbac.hasAllRoles(0xfoo, RbacRoles.ADMIN & RbacRoles.MANAGER)\n   *\n   * @public\n   * @param {Address} account\n   * @param {RbacRoles} roles\n   * @param {?ReadParams} [params]\n   * @returns {Promise<boolean>}\n   */\n  public hasAllRoles(\n    account: Address,\n    roles: Roles,\n    params?: ReadParams<typeof rbacAbi, 'hasAllRoles'>,\n  ) {\n    return readRbacHasAllRoles(this._config, {\n      address: this.assertValidAddress(),\n      args: [account, roles],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n  }\n\n  /**\n   * Check if the given account is authorized to use the rbac\n   *\n   * @public\n   * @param {Address} account\n   * @param {?ReadParams} [params]\n   * @returns {Promise<boolean>} - True if the account is authorized\n   */\n  public isAuthorized(\n    account: Address,\n    params?: ReadParams<typeof rbacAbi, 'isAuthorized'>,\n  ) {\n    return readRbacIsAuthorized(this._config, {\n      address: this.assertValidAddress(),\n      args: [account],\n      ...this.optionallyAttachAccount(),\n      // biome-ignore lint/suspicious/noExplicitAny: Accept any shape of valid wagmi/viem parameters, wagmi does the same thing internally\n      ...(params as any),\n    });\n  }\n}\n"],"names":["Roles","DeployableTargetWithRBAC","DeployableTarget","addresses","allowed","params","request","result","simulateRbacSetAuthorized","writeRbacSetAuthorized","roles","simulateRbacGrantRoles","writeRbacGrantRoles","simulateRbacRevokeRoles","writeRbacRevokeRoles","account","readRbacRolesOf","role","readRbacHasAnyRole","readRbacHasAllRoles","readRbacIsAuthorized"],"mappings":"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"}