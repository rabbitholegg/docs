{"version":3,"file":"Deployable.js","sources":["../../src/Deployable/Deployable.ts"],"sourcesContent":["import { type Config, deployContract } from '@wagmi/core';\nimport type {\n  Abi,\n  Account,\n  Address,\n  ContractEventName,\n  Hash,\n  Hex,\n  WaitForTransactionReceiptParameters,\n} from 'viem';\nimport {\n  DeployableAlreadyDeployedError,\n  DeployableBuildParametersUnspecifiedError,\n  DeployableMissingPayloadError,\n  DeployableWagmiConfigurationRequiredError,\n} from '../errors';\nimport { getDeployedContractAddress } from '../utils';\nimport { Contract } from './Contract';\n\n/**\n * A base class representing a deployable contract, contains base implementations for deployment and initialization payload construction.\n *\n * @export\n * @typedef {GenericDeployableParams}\n */\nexport type GenericDeployableParams = Omit<\n  Parameters<typeof deployContract>[1],\n  'args' | 'account'\n> & {\n  args: [Hex, ...Array<Hex>];\n  account?: Account;\n};\n\n/**\n * A generic type that encapsulates either an initialization payload for a contract, or a valid address for a previously deployed contract.\n *\n * @export\n * @typedef {DeployablePayloadOrAddress}\n * @template [Payload=unknown]\n */\nexport type DeployablePayloadOrAddress<Payload = unknown> = Payload | Address;\n\n/**\n * Instantion options for the base deployable.\n *\n * @export\n * @interface DeployableOptions\n * @typedef {DeployableOptions}\n */\nexport interface DeployableOptions {\n  /**\n   * [Wagmi Configuration](https://wagmi.sh/core/api/createConfig)\n   *\n   * @see {@link Config}\n   * @type {Config}\n   */\n  config: Config;\n  /**\n   * [Viem Local Account](https://viem.sh/docs/accounts/local), required if in a Node environment\n   *\n   * @see {@link Account}\n   * @type {?Account}\n   */\n  account?: Account;\n}\n\n/**\n * A generic deployable contract that encapsulates common operations related to contract deployment\n *\n * @export\n * @class Deployable\n * @typedef {Deployable}\n * @template [Payload=unknown]\n * @template {Abi} [ContractAbi=[]]\n * @template {ContractEventName<ContractAbi>} [ContractEvent=ContractEventName<ContractAbi>]\n * @extends {Contract<ContractAbi, ContractEvent>}\n */\nexport class Deployable<\n  Payload,\n  ContractAbi extends Abi,\n> extends Contract<ContractAbi> {\n  /**\n   * The deployable payload used either for contract construction or initialization\n   *\n   * @protected\n   * @type {(Payload | undefined)}\n   */\n  protected _payload: Payload | undefined;\n  /**\n   * If it exists, [Viem Local Account](https://viem.sh/docs/accounts/local), if in a Node environment\n   *\n   * @protected\n   * @type {?Account}\n   */\n  protected _account?: Account;\n\n  /**\n   * Creates an instance of Deployable.\n   *\n   * @constructor\n   * @param {DeployableOptions} param0\n   * @param {?Account} [param0.account]\n   * @param {Config} param0.config\n   * @param {DeployablePayloadOrAddress<Payload>} payload\n   */\n  constructor(\n    { account, config }: DeployableOptions,\n    payload?: DeployablePayloadOrAddress<Payload>,\n  ) {\n    if (typeof payload === 'string') {\n      super(config, payload as Address);\n    } else {\n      super(config, undefined);\n      this._payload = payload as Payload;\n    }\n    if (account) this._account = account;\n  }\n\n  /**\n   * Returns the attached deployable payload, if it exists\n   *\n   * @readonly\n   * @type {Payload}\n   */\n  get payload() {\n    return this._payload;\n  }\n\n  /**\n   * Attaches a new payload for use with this deployable's initialization\n   *\n   * @public\n   * @param {Payload} payload\n   * @returns {this}\n   */\n  public withPayload(payload: Payload) {\n    this._payload = payload;\n    return this;\n  }\n\n  /**\n   * High level deployment function to deploy and await the contract address.\n   * This is mainly a convenience method to easily deploy a contract, but will not initialize a `Cloneable`,\n   * which makes it useless for Boost components.\n   * Obviously you can ignore the TS warnings and use this, but you shouldn't in most all cases.\n   *\n   * @public\n   * @async\n   * @param {?Payload} [_payload]\n   * @param {?DeployableOptions} [_options]\n   * @param {?Omit<WaitForTransactionReceiptParameters, 'hash'>} [waitParams] - See [viem.WaitForTransactionReceipt](https://v1.viem.sh/docs/actions/public/waitForTransactionReceipt.html#waitfortransactionreceipt)\n   * @returns {Promise<this>}\n   */\n  protected async deploy(\n    _payload?: Payload,\n    _options?: DeployableOptions,\n    waitParams?: Omit<WaitForTransactionReceiptParameters, 'hash'>,\n  ) {\n    const config = _options?.config || this._config;\n    const address = await getDeployedContractAddress(\n      config,\n      this.deployRaw(_payload, _options),\n      waitParams,\n    );\n    this._address = address;\n    return this;\n  }\n\n  /**\n   * The lower level contract deployment function that does not await for the transaction receipt.\n   * This is mainly a convenience method to easily deploy a contract, but will not initialize a `Cloneable`,\n   * which makes it useless for Boost components.\n   * Obviously you can ignore the TS warnings and use this, but you shouldn't in most all cases.\n   *\n   * @public\n   * @async\n   * @param {?Payload} [_payload]\n   * @param {?DeployableOptions} [_options]\n   * @returns {Promise<Hash>}\n   * @throws {@link DeployableAlreadyDeployedError}\n   * @throws {@link DeployableWagmiConfigurationRequiredError}\n   * @throws {@link DeployableMissingPayloadError}\n   */\n  protected async deployRaw(\n    _payload?: Payload,\n    _options?: DeployableOptions,\n  ): Promise<Hash> {\n    if (this.address) throw new DeployableAlreadyDeployedError(this.address);\n    const [payload, options] = this.validateDeploymentConfig(\n      _payload,\n      _options,\n    );\n    return await deployContract(options.config, {\n      ...this.buildParameters(payload),\n      ...this.optionallyAttachAccount(options.account),\n    });\n  }\n\n  /**\n   * Internal function to attach the connected account to write methods to avoid manually passing in an account each call.\n   *\n   * @protected\n   * @param {?Account} [account]\n   * @returns {({ account: Account; } | { account?: undefined; })}\n   */\n  protected optionallyAttachAccount(account?: Account) {\n    if (account) return { account };\n    return this._account ? { account: this._account } : {};\n  }\n\n  /**\n   * Base parameter constructor, should return a partial `viem.deployContract` parameters shape including abi, bytecode, and arguments, if any.\n   * Expected to be overridden by protocol contracts.\n   *\n   * @public\n   * @param {?Payload} [_payload]\n   * @param {?DeployableOptions} [_options]\n   * @returns {GenericDeployableParams}\n   */\n  public buildParameters(\n    _payload?: Payload,\n    _options?: DeployableOptions,\n  ): GenericDeployableParams {\n    throw new DeployableBuildParametersUnspecifiedError();\n  }\n\n  /**\n   * Internal method used to ensure that a Wagmi configuration and payload are always present when deploying.\n   *\n   * @protected\n   * @template [P=Payload]\n   * @param {?P} [_payload]\n   * @param {?DeployableOptions} [_options]\n   * @returns {[P, DeployableOptions]}\n   * @throws {@link DeployableWagmiConfigurationRequiredError}\n   * @throws {@link DeployableMissingPayloadError}\n   */\n  protected validateDeploymentConfig<P = Payload>(\n    _payload?: P,\n    _options?: DeployableOptions,\n  ) {\n    const options = _options || {\n      config: this._config,\n      account: this._account,\n    };\n    if (!options) throw new DeployableWagmiConfigurationRequiredError();\n    const payload = _payload || this._payload;\n    return [payload, options] as [P, DeployableOptions];\n  }\n}\n"],"names":["Deployable","Contract","account","config","payload","_payload","_options","waitParams","address","getDeployedContractAddress","DeployableAlreadyDeployedError","options","deployContract","DeployableBuildParametersUnspecifiedError","DeployableWagmiConfigurationRequiredError"],"mappings":";;;;AA6EO,MAAMA,UAGHC,EAAsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAyB9B,YACE,EAAE,SAAAC,GAAS,QAAAC,EAAA,GACXC,GACA;AACI,IAAA,OAAOA,KAAY,WACrB,MAAMD,GAAQC,CAAkB,KAEhC,MAAMD,GAAQ,MAAS,GACvB,KAAK,WAAWC,IAEdF,WAAc,WAAWA;AAAA,EAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,IAAI,UAAU;AACZ,WAAO,KAAK;AAAA,EACd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASO,YAAYE,GAAkB;AACnC,gBAAK,WAAWA,GACT;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAeA,MAAgB,OACdC,GACAC,GACAC,GACA;AACM,UAAAJ,KAASG,KAAA,gBAAAA,EAAU,WAAU,KAAK,SAClCE,IAAU,MAAMC;AAAA,MACpBN;AAAA,MACA,KAAK,UAAUE,GAAUC,CAAQ;AAAA,MACjCC;AAAA,IAAA;AAEF,gBAAK,WAAWC,GACT;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAiBA,MAAgB,UACdH,GACAC,GACe;AACf,QAAI,KAAK,QAAS,OAAM,IAAII,EAA+B,KAAK,OAAO;AACvE,UAAM,CAACN,GAASO,CAAO,IAAI,KAAK;AAAA,MAC9BN;AAAA,MACAC;AAAA,IAAA;AAEK,WAAA,MAAMM,EAAeD,EAAQ,QAAQ;AAAA,MAC1C,GAAG,KAAK,gBAAgBP,CAAO;AAAA,MAC/B,GAAG,KAAK,wBAAwBO,EAAQ,OAAO;AAAA,IAAA,CAChD;AAAA,EACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASU,wBAAwBT,GAAmB;AAC/C,WAAAA,IAAgB,EAAE,SAAAA,MACf,KAAK,WAAW,EAAE,SAAS,KAAK,aAAa;EACtD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAWO,gBACLG,GACAC,GACyB;AACzB,UAAM,IAAIO,EAA0C;AAAA,EACtD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAaU,yBACRR,GACAC,GACA;AACA,UAAMK,IAAUL,KAAY;AAAA,MAC1B,QAAQ,KAAK;AAAA,MACb,SAAS,KAAK;AAAA,IAAA;AAEhB,QAAI,CAACK,EAAe,OAAA,IAAIG;AAEjB,WAAA,CADST,KAAY,KAAK,UAChBM,CAAO;AAAA,EAC1B;AACF;"}